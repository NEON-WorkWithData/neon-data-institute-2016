---
layout: post
title: "Classify a raster by threshold values in R"
date:   2016-06-19
authors: [Leah A. Wasser, Kyla Dahlin]
instructors: [Leah A. Wasser]
time: "10:15 am"
contributors: [Edmund Hart]
dateCreated:  2016-05-01
lastModified: `r format(Sys.time(), "%Y-%m-%d")`
packagesLibraries: [rhdf5]
categories: [self-paced-tutorial]
mainTag: institute-day2
tags: [R, HDF5]
tutorialSeries: [institute-day2]
description: "Classify using threshold."
code1: .R
image:
  feature: 
  credit: 
  creditlink:
permalink: /R/classify-by-threshold-R/
comments: false
---

First, let's load the required libraries.

```{r load-libraries, warning=FALSE, results='hide', message=FALSE}
# load libraries
library(raster)
library(rhdf5)
library(rgdal)

setwd("~/Documents/data/1_data-institute-2016")

# import functions
source("/Users/lwasser/Documents/GitHub/neon-aop-package/neonAOP/R/aop-data.R")

```

## Import LiDAR data

```{r import-lidar }

# note: plotting to look at things as you go is always recommmended!
  
# first we read in the LiDAR data

# dsm = digital surface model == top of canopy
dsm <- raster("Teakettle/may1_subset/lidar/Teak_lidarDSM.tif")
# dtm = digital terrain model = elevation
dtm <- raster("Teakettle/may1_subset/lidar/Teak_lidarDTM.tif") 

# rename to CHM
# chm <- dsm - dtm
chm <- raster("Teakettle/may1_subset/lidar/Teak_lidarCHM.tif")
# assign chm values of 0 to NA
chm[chm==0] <- NA

# do the numbers look reasonable? 60 m is tall for a tree, but
# this is Ponderosa pine territory (I think), so not out of the question.
plot(chm,
     main="Canopy Height - Teakettle \nCalifornia") 

hist(chm,
     main="Distribution of Canopy Height - Teakettle \nCalifornia",
     xlab="Tree Height (m)", 
     col="springgreen")

```



```{r import-aspect-data }

# (1) calculate aspect of cropped DTM
# aspect <- terrain(all.data[[3]], opt = "aspect", unit = "degrees", neighbors = 8)
aspect <- raster("Teakettle/may1_subset/lidar/Teak_lidarAspect.tif")

plot(aspect,
     main="Aspect for Teakettle Field Site",
     axes=F)

# crop the data to the extent of the other rasters we are working with!
# aspect <- crop(aspect, overlap)
```

## Threshold Based Raster Classification

Next, we will create a classified raster object.
To do this we need to 

1. create a matrix containing the threhold ranges and the associated "class"
2. use the `raster::reclassify` function to create a new raster.

Our range of values are as follows:
We will assign all north facing slopes "1" and south facing "2". 

**North Facing Slopes:** 0-45 degrees, 315-360 degrees; class=1
**South Facing Slopes:** 135-225 degrees; class=2


```{r classify-raster }

# first create a matrix of values that represent the classification ranges
# North face = 1
# South face = 2
class.m <- c(0, 45, 1, 
             45, 135, NA, 
             135, 225, 2,  
             225 , 315, NA, 
             315, 360, 1)
class.m
# shape the object into a matrix with columns and rows
rcl.m <- matrix(class.m, ncol=3, byrow=TRUE)
rcl.m
# reclassify the raster using the reclass object - rcl.m
asp.ns <- reclassify(aspect, rcl.m)

plot(asp.ns, 
     col=c("white","blue","green"),
     main="North and South Facing Slopes \nTeakettle",
     xlim=c(326000, 526000),
     legend=F)

legend("topright",
       legend = c("North", "South"),
       fill = c("blue", "green"))


# north.facing <- asp.ns==1
# south.facing <- asp.ns==2

# north.facing[north.facing == 0] <- NA
# south.facing[south.facing == 0] <- NA

# export geotiff 
writeRaster(asp.ns,
            filename="Teakettle/outputs/Teak_nsAspect.tif",
            format="GTiff",
            options="COMPRESS=LZW",
            overwrite = TRUE,
            NAflag = -9999)


```

## Mask Data

Once we have created a threhold classified raster, we can use it for different things.
One application may be to mask another dataset. 

Let's try to find all pixels that have an NDVI value >.6 and are north facing. 

```{r mask-data }
# w use dave's NDVI layer but for now...

# Define the file name to be opened
f <- "Teakettle/may1_subset/spectrometer/Subset3NIS1_20130614_100459_atmcor.h5"

# define the CRS in EPGS format for the file
epsg <- 32611
# create a list of bands
bands <- c(60,83)

ndvi.stack <- create_stack(f, 
                           bands, 
                           epsg=32611)

# calculate NDVI
ndvi <- (ndvi.stack[[2]]-ndvi.stack[[1]]) / (ndvi.stack[[2]]+ndvi.stack[[1]])
names(ndvi) <- "Teak_hsiNDVI"

# let's test this out
plot(ndvi)

# let's create a mask
ndvi[ndvi<.6] <- NA
plot(ndvi)

# force the two to have the same CRS
crs(ndvi) <- crs(asp.ns)
# the two are different extents, crop both
if(gIntersection(extent(ndvi), extent(asp.ns))){
  print("they overlap")
}

# mask out only pixels that are north facing and NDVI >.6
nFacing.ndvi <- mask(asp.ns,ndvi)

```

