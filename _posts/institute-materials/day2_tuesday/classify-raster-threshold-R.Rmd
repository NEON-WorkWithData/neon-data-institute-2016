---
layout: post
title: "Classify a raster using threshold values in R"
date:   2016-06-17
authors: [Leah A. Wasser, Kyla Dahlin]
instructors: [Leah, Naupaka]
time: "10:15"
contributors:
dateCreated:  2016-05-01
lastModified: `r format(Sys.time(), "%Y-%m-%d")`
packagesLibraries: [raster]
categories: [self-paced-tutorial]
mainTag: institute-day2
tags: [R, HDF5]
tutorialSeries: [institute-day2]
description: "Classify using threshold."
code1: institute-materials/day2_tuesday/classify-raster-threshold-R.R
image:
  feature: 
  credit: 
  creditlink:
permalink: /R/classify-by-threshold-R/
comments: false
---

## About

In this tutorial, we will walk through how to classify a raster file using
defined value ranges in R. 

First, let's load the required libraries.

```{r load-libraries, warning=FALSE, results='hide', message=FALSE}
# load libraries
library(raster)
library(rhdf5)
library(rgdal)

# set your working directory
setwd("~/Documents/data/1_data-institute-2016")

# import functions
source("/Users/lwasser/Documents/GitHub/neon-aop-package/neonAOP/R/aop-data.R")

```

## Import LiDAR data

To begin, we will open the NEON LiDAR Digital Surface and Digital Terrain Models
(DSM and DTM) which are in Geotiff format.

```{r import-lidar }

# read LiDAR data
# dsm = digital surface model == top of canopy
dsm <- raster("NEONdata/TEAK/2013/lidar/Teak_lidarDSM.tif")
# dtm = digital terrain model = elevation
dtm <- raster("NEONdata/TEAK/2013/lidar/Teak_lidarDTM.tif") 

# lets also import the canopy height model (CHM).
chm <- raster("NEONdata/TEAK/2013/lidar/Teak_lidarCHM.tif")

```

## View CHM

``` {r explore-chm}
# assign chm values of 0 to NA
chm[chm==0] <- NA

# do the numbers look reasonable? 60 m is tall for a tree, but
# this is Ponderosa pine territory (I think), so not out of the question.
plot(chm,
     main="Canopy Height - Teakettle \nCalifornia") 

hist(chm,
     main="Distribution of Canopy Height - Teakettle \nCalifornia",
     xlab="Tree Height (m)", 
     col="springgreen")


```

## Import Aspect Data

Next, we'll import an aspect dataset - one of the NEON data products.

# DEFINE this data product & Make sure TRISTAN covers it.

<i class="fa fa-star"></i> **Data Tip:** You can calculate aspect in R 
using if you have a surface or elevation model as follows:  
`terrain(your.raster.data, opt = "aspect", unit = "degrees", neighbors = 8)` .
{: .notice}

```{r import-aspect-data }

# (1) calculate aspect of cropped DTM
# aspect <- terrain(all.data[[3]], opt = "aspect", unit = "degrees", neighbors = 8)
aspect <- raster("NEONdata/TEAK/2013/lidar/Teak_lidarAspect.tif")

plot(aspect,
     main="Aspect for Teakettle Field Site",
     axes=F)

```

## Threshold Based Raster Classification

Next, we will create a classified raster object.
To do this we need to:

1. Create a matrix containing the threhold ranges and the associated "class"
2. Use the `raster::reclassify` function to create a new raster.

Our range of values are as follows:
We will assign all north facing slopes "1" and south facing "2". 

**North Facing Slopes:** 0-45 degrees, 315-360 degrees; class=1
**South Facing Slopes:** 135-225 degrees; class=2


```{r classify-raster }

# first create a matrix of values that represent the classification ranges
# North face = 1
# South face = 2
class.m <- c(0, 45, 1, 
             45, 135, NA, 
             135, 225, 2,  
             225 , 315, NA, 
             315, 360, 1)
class.m

# shape the object into a matrix with columns and rows
rcl.m <- matrix(class.m, ncol=3, byrow=TRUE)
rcl.m

# reclassify the raster using the reclass object - rcl.m
asp.ns <- reclassify(aspect, rcl.m)

# plot outside of the plot region
# make room for a legend
par(xpd = FALSE, mar=c(5.1, 4.1, 4.1, 4.5))

plot(asp.ns, 
     col=c("white","blue","green"),
     main="North and South Facing Slopes \nTeakettle",
     legend=F)

# allow legend to plot outside of bounds
par(xpd=TRUE)

legend((par()$usr[2] + 20), 4103300, # set xy legend location
       legend = c("North", "South"),
       fill = c("blue", "green"), 
       bty="n") # turn off border

```

## Export Classified Raster

```{r export-geotiff, eval=FALSE}

# export geotiff 
writeRaster(asp.ns,
            filename="Teakettle/outputs/Teak_nsAspect.tif",
            format="GTiff",
            options="COMPRESS=LZW",
            overwrite = TRUE,
            NAflag = -9999)

```

<div id="challenge" markdown="1">
## Challenge

Take the markdown file that you just created in this lesson. Imagine that you are
your future self. Add some additional documentation that describes the steps that 
you took to classify a raster in R and "analyze" / describe the outputs. Do
they tell you anything about vegetation structure at the field site?

When you are done, add to this markdown document. Create the following threshold 
classified outputs:

1. A raster where NDVI values are classified 0 (low greenness <.3),
1 (.3-.6),2 (>.6) 
2. A raster where canopy height is classified. Explore the CHM data and chose 
threshold values that make sense given the distribution of values in the data.

Be sure to document your workflow as you go using Markdown within your R Markdown
document.

When you are done, knit your outputs to html and push them to your git directory.
</div>
